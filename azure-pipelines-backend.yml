trigger:
  branches:
    include:
      - main

variables:
  imageName: backend-app

stages:
- stage: BuildAndPush
  displayName: Build and Push Docker Image
  jobs:
  - job: Build
    pool:
      vmImage: ubuntu-latest
    steps:
    - task: Docker@2
      inputs:
        containerRegistry: 'dockerhub-ebtwim'
        repository: 'ebtwim/$(imageName)'
        command: 'buildAndPush'
        Dockerfile: 'api/Dockerfile'
        tags: latest

- stage: Deploy
  displayName: Deploy to AKS
  dependsOn: BuildAndPush
  jobs:
  - job: Deploy
    pool:
      vmImage: ubuntu-latest
    steps:
    - task: KubernetesManifest@1
      inputs:
        action: deploy
        connectionType: 'kubernetesServiceConnection'
        kubernetesServiceConnection: 'k8s-connection'
        namespace: 'project'
        manifests: |
          backend_deploy.yml
          backend_cluster_ip.yml
          backend_ingress.yml

    # âœ… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø´Ø±
    - task: AzureCLI@2
      displayName: 'Get Ingress and Service Info (namespace: project)'
      inputs:
        azureSubscription: 'SDA-capstone-aks'  # <-- ØºÙŠÙ‘Ø± Ø§Ù„Ø§Ø³Ù… Ù„Ùˆ ÙƒØ§Ù† Ù…Ø®ØªÙ„Ù
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "ðŸ” Getting Kubernetes info in 'project' namespace..."

          echo "ðŸ‘‰ Ingress and services:"
          kubectl get ingress -n project
          kubectl get svc -n project
          kubectl get pods -n project
          kubectl describe ingress -n project

          echo "ðŸ‘‰ Ingress Controller (ingress-nginx):"
          kubectl get pods -n ingress-nginx
          kubectl get svc -n ingress-nginx
