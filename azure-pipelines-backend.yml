trigger:
  branches:
    include:
      - main

variables:
  imageName: backend-app

stages:
- stage: BuildAndPush
  displayName: Build and Push Docker Image
  jobs:
  - job: Build
    pool:
      vmImage: ubuntu-latest
    steps:
    - task: Docker@2
      inputs:
        containerRegistry: 'dockerhub-ebtwim'
        repository: 'ebtwim/$(imageName)'
        command: 'buildAndPush'
        Dockerfile: 'api/Dockerfile'
        tags: latest

- stage: Deploy
  displayName: Deploy to AKS
  dependsOn: BuildAndPush
  jobs:
  - job: Deploy
    pool:
      vmImage: ubuntu-latest
    steps:
    
    # ğŸ› ï¸ ØªØ«Ø¨ÙŠØª ingress-nginx Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Helm
    - task: AzureCLI@2
      displayName: 'Install ingress-nginx via Helm'
      inputs:
        azureSubscription: 'Azure subscription for Capstone'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "ğŸ“¥ Getting AKS credentials..."
          az aks get-credentials \
            --resource-group DevOps1-CapstoneProject-champ-rg \
            --name DevOps1-CapstoneProject-champ-aks \
            --overwrite-existing

          echo "ğŸ“¦ Adding ingress-nginx repo and installing ingress controller..."
          helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
          helm repo update

          # ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯Ù‡ Ù…Ø³Ø¨Ù‚Ù‹Ø§ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø®Ø·Ø£
          helm status nginx-ingress -n ingress-nginx || helm install nginx-ingress ingress-nginx/ingress-nginx \
            --namespace ingress-nginx \
            --create-namespace \
            --set controller.ingressClassResource.name=nginx \
            --set controller.ingressClassResource.controllerValue=k8s.io/ingress-nginx \
            --set controller.service.type=LoadBalancer

    # ğŸš€ Ù†Ø´Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù„ÙØ§Øª Kubernetes
    - task: KubernetesManifest@1
      displayName: 'Deploy Backend to AKS'
      inputs:
        action: deploy
        connectionType: 'kubernetesServiceConnection'
        kubernetesServiceConnection: 'k8s-connection'
        namespace: 'project'
        manifests: |
          backend_deploy.yml
          backend_cluster_ip.yml
          backend_ingress.yml

    # ğŸ” Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø¯Ù…Ø§Øª ÙˆØ§Ù„Ù€ ingress
    - task: AzureCLI@2
      displayName: 'Get Ingress and Service Info'
      inputs:
        azureSubscription: 'Azure subscription for Capstone'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          echo "ğŸ“¥ Getting AKS credentials again (if needed)..."
          az aks get-credentials \
            --resource-group DevOps1-CapstoneProject-champ-rg \
            --name DevOps1-CapstoneProject-champ-aks \
            --overwrite-existing

          echo "ğŸŒ Ingress and services in 'project' namespace:"
          kubectl get ingress -n project
          kubectl describe ingress -n project
          kubectl get svc -n project
          kubectl get pods -n project
          kubectl get events -n project --sort-by=.metadata.creationTimestamp

          echo "ğŸŒ Ingress Controller (ingress-nginx) status:"
          kubectl get svc -n ingress-nginx
          kubectl get pods -n ingress-nginx
